{% extends 'base.html' %}

{% block title %}Character Edit{% endblock %}

{% block script_tags%}
<script src="https://cdnjs.cloudflare.com/ajax/libs/tinymce/6.2.0/tinymce.min.js" integrity="sha512-tofxIFo8lTkPN/ggZgV89daDZkgh1DunsMYBq41usfs3HbxMRVHWFAjSi/MXrT+Vw5XElng9vAfMmOWdLg0YbA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tinymce/6.2.0/plugins/emoticons/plugin.min.js" integrity="sha512-G42q3WE7uNjJHFlnBQdFxo3pjbv9lCBy9dctoscYJfSnyh2Bcek3z/90dAJrO442jj+/FuXt037KIs+Nz60A4w==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
<script src="https://code.jquery.com/jquery-3.6.1.min.js" integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ=" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>
{% endblock %}

{% block content %}
    {% block form %}
        <form method="post" id="character_form">


            <!-- Name -->
            <label for="name">Name</label>
            <input name="name" id="name" value="{{character.name}}" placeholder="Your Character Name" required>
            <input name="character_id" id="character_id" type="text" value="{{character.editable_id}}" hidden>
            
            <div id="iamge_selection">
                <label for="images">Images</label>
                <input type="text" name="images" class="images">
            </div>

            <!-- Description -->
            <p>Description</p>
            <div id="text_editor" style="display: flex; justify-content:center; padding: 5vh 0 5vh 0">
                <div id="text_box" style="width: 90vw; height: 50vh; box-shadow: -2px 6px 43px 26px rgba(62,65,72,0.18);
                -webkit-box-shadow: -2px 6px 43px 26px rgba(62,65,72,0.18);
                -moz-box-shadow: -2px 6px 43px 26px rgba(62,65,72,0.18);">
                    <textarea id="description">Description Text</textarea>
                </div>
            </div>

            <!-- Location -->
            <div id="location_selection">
                <label for="location">Location</label>
                <input type="text" name="location" id="location_input" value="{{character.location.name if character.location else ''}}">
                <input type="text" name="location_id" id="location_id" value="{{character.location.editable_id if character.location else ''}}" hidden>
            </div>

            <hr>

            <!-- Trait Selection -->
            <div id="trait_selection">
                <label for="traits">Traits</label>
                
                {% for trait in character.traits %}
                <div class="trait">
                    <input type="text" name="single_trait" class="single_trait" value="{{trait.name if trait.name else ''}}" placeholder="Trait">
                    <input type="text" name="single_trait_desc" class="single_trait_desc" value="{{trait.short_description if trait.short_description else ''}}" placeholder="Short Description">
                    <button type="button" class="remove_trait">-</button>
                </div>
                {% endfor %}

                {% if not character.traits %}
                <div class="trait">
                    <input type="text" name="single_trait" class="single_trait" placeholder="Trait">
                    <input type="text" name="single_trait_desc" class="single_trait_desc" placeholder="Short Description">
                    <button type="button" class="remove_trait">-</button>
                </div>
                {% endif %}

                <button type="button" id="add_trait">Add Trait</button>
            </div>

            <hr>

            <!-- Stat Selection -->
            <div id="stat_selection">
                <label for="stats">Stats</label>
                {% for stat in character.stats %}
                <div class="stat">
                    <input type="text" name="single_stat" class="single_stat" value="{{stat.name if stat.name else ''}}" placeholder="Stat">
                    <input type="text" name="single_stat_desc" class="single_stat_desc" value="{{stat.short_description if stat.short_description else ''}}" placeholder="Short Description">
                    <button type="button" class="remove_stat">-</button>
                </div>
                {% endfor %}

                {% if not character.stats %}
                <div class="stat">
                    <input type="text" name="single_stat" class="single_stat" placeholder="Trait">
                    <input type="text" name="single_stat_desc" class="single_stat_desc" placeholder="Short Description">
                    <button type="button" class="remove_stat">-</button>
                </div>
                {% endif %}

                <button type="button" id="add_stat">Add Stat</button>
            </div>

            <hr>
            
            <!-- Relationship Selection -->
            <div id="relationship_selection">
                <label for="relationships">Relationships</label>
                {% for relationship in character.relationships %}
                <div class="relationship">
                    <input type="text" name="single_relationship" class="single_relationship" value="{{relationship.name if relationship.name else ''}}" placeholder="Relationship">
                    <input type="text" name="relationship_character" class="relationship_character" value="{{relationship.character.name if relationship.character else ''}}" placeholder="Character">
                    <input type="text" name="relationship_character_id" class="relationship_character_id" value="{{relationship.character.editable_id if relationship.character else ''}}" hidden>
                    <input type="text" name="single_relationship_desc" class="single_relationship_desc" value="{{relationship.short_description if relationship.short_description else ''}}" placeholder="Short Description">
                    <button type="button" class="remove_relationship">-</button>
                </div>
                {% endfor %}

                {% if not character.relationships %}
                <div class="relationship">
                    <input type="text" name="single_relationship" class="single_relationship" placeholder="Relationship">
                    <input type="text" name="relationship_character" class="relationship_character" placeholder="Character">
                    <input type="text" name="relationship_character_id" class="relationship_character_id" hidden>
                    <input type="text" name="single_relationship_desc" class="single_relationship_desc" placeholder="Short Description">
                    <button type="button" class="remove_relationship">-</button>
                </div>
                {% endif %}

                <button type="button" id="add_relationship">Add Relationships</button>
            </div>

            <hr>

            <!-- Familiar Selection -->
            <div id="familiar_selection">
                <label for="familiar">Familiar</label>
                {% for familiar in character.familiars %}
                <div class="familiar">
                    <input type="text" name="single_familiar" class="single_familiar" value="{{familiar.name if familiar.name else ''}}" placeholder="Familiar">
                    <input name="familiar_id" id="familiar_id" type="text" value="{{familiar.editable2_id}}" hidden>
                    <button type="button" class="remove_familiar">-</button>
                </div>
                {% endfor %}

                {% if not character.familiars %}
                <div class="familiar">
                    <input type="text" name="single_familiar" class="single_familiar" placeholder="Familiar">
                    <input name="familiar_id" id="familiar_id" type="text" hidden>
                    <button type="button" class="remove_familiar">-</button>
                </div>
                {% endif %}

                <button type="button" id="add_familiar">Add Familiar</button>
            </div>

            <hr>

            <!-- Inventory Selection -->
            <div id="inventory_selection">
                <label for="inventory">Inventory</label>
                {% for inventory in character.inventories %}
                <div class="inventory">
                    <input type="text" name="single_inventory" class="single_inventory" value="{{inventory.name if inventory.name else ''}}" placeholder="Inventory">
                    <button type="button" class="remove_inventory">-</button>
                </div>
                {% endfor %}

                {% if not character.inventories %}
                <div class="inventory">
                    <input type="text" name="single_inventory" class="single_inventory" placeholder="Inventory">
                    <button type="button" class="remove_inventory">-</button>
                </div>
                {% endif %}

                <button type="button" id="add_inventory">Add Inventory</button>
            </div>

            <hr>

            <!-- Editor Selection -->
            <div id="editor_selection">
                <label for="editor">Editor</label>
                {% for editor in character.editors %}
                <div class="editor">
                    <input type="text" name="single_editor" class="single_editor" value="{{editor.name if editor.name else ''}}" placeholder="Editor">
                    <input type="text" name="editor_id" id="editor_id" value="{{editor.id}}" hidden>
                    <button type="button" class="remove_editor">-</button>
                </div>
                {% endfor %}

                {% if not character.editors %}
                <div class="editor">
                    <input type="text" name="single_editor" class="single_editor" placeholder="Editor">
                    <input type="text" name="editor_id" id="editor_id" hidden>
                    <button type="button" class="remove_editor">-</button>
                </div>
                {% endif %}

                <button type="button" id="add_editor">Add Editor</button>
            </div>

        </form>

        <button id="log">
            log
        </button>
    {% endblock %}

    {% block options %}
        <button id="confirm">Confirm</button>

        <a href="{{url_for('navi.character_page', character_id = character.editable_id)}}">
            <button id="discard">Discard</button>
        </a>
    {% endblock %}

    <div id="hidden_description" hidden>
        {% autoescape false %}
            {{character.description}}
        {% endautoescape %}
    </div>
{% endblock %}

{% block script %}
    <script>
        var trait_snippet = `<div class="trait">
                                <input type="text" name="single_trait" class="single_trait" placeholder="Trait">
                                <input type="text" name="single_trait_desc" class="single_trait_desc" placeholder="Short Description">
                                <button type="button" class="remove_trait">-</button>
                            </div>`

        var stat_snippet = `<div class="stat">
                                <input type="text" name="single_stat" class="single_stat" placeholder="Trait">
                                <input type="text" name="single_stat_desc" class="single_stat_desc" placeholder="Short Description">
                                <button type="button" class="remove_stat">-</button>
                            </div>`

        var relationship_snippet = `<div class="relationship">
                                        <input type="text" name="single_relationship" class="single_relationship" placeholder="Relationship">
                                        <input type="text" name="relationship_character" class="relationship_character" placeholder="Character">
                                        <input type="text" name="relationship_character_id" class="relationship_character_id" hidden>
                                        <input type="text" name="single_relationship_desc" class="single_relationship_desc" placeholder="Short Description">
                                        <button type="button" class="remove_relationship">-</button>
                                    </div>`
        
        var familiar_snippet = `<div class="familiar">
                                    <input type="text" name="single_familiar" class="single_familiar" placeholder="Familiar">
                                    <input name="familiar_id" id="familiar_id" type="text" hidden>
                                    <button type="button" class="remove_familiar">-</button>
                                </div>`
        
        var inventory_snippet = `<div class="inventories">
                                    <input type="text" name="single_inventory" class="single_inventory" placeholder="Inventory">
                                    <button type="button" class="remove_inventory">-</button>
                                </div>`

        var editor_snippet = `<div class="editor">
                                <input type="text" name="single_editor" class="single_editor" placeholder="Editor">
                                <input type="text" name="editor_id" id="editor_id" hidden>
                                <button type="button" class="remove_editor">-</button>
                            </div>`

        $(document).ready(function() {

            tinymce.init({
                selector: 'textarea#description',
                promotion: false,
                resize: false,
                height: '100%',
                plugins: 'emoticons',
                toolbar: 'undo redo | styleselect | bold italic | ' +
                'alignleft aligncenter alignright alignjustify | ' +
                'outdent indent | numlist bullist | emoticons',
                setup: function (editor) {
                    editor.on('init', function (e) {
                      editor.setContent($('#hidden_description')[0].innerHTML);
                    });
                }
            });

            $('#add_trait').on('click', function(evt) {
                if($(this).siblings('.trait').length > 0){
                    $(this).siblings('.trait').last().after(trait_snippet)
                }else{
                    $(this).before(trait_snippet)
                }
            })

            $('#add_stat').on('click', function(evt) {
                if($(this).siblings('.stat').length > 0){
                    $(this).siblings('.stat').last().after(stat_snippet)
                }else{
                    $(this).before(stat_snippet)
                }
            })

            $('#add_familiar').on('click', function(evt) {
                if($(this).siblings('.familiar').length > 0){
                    $(this).siblings('.familiar').last().after(familiar_snippet)
                }else{
                    $(this).before(familiar_snippet)
                }
            })

            $('#add_relationship').on('click', function(evt) {
                if($(this).siblings('.relationship').length > 0){
                    $(this).siblings('.relationship').last().after(relationship_snippet)
                }else{
                    $(this).before(relationship_snippet)
                }
            })

            $('#add_inventory').on('click', function(evt) {
                if($(this).siblings('.inventory').length > 0){
                    $(this).siblings('.inventory').last().after(inventory_snippet)
                }else{
                    $(this).before(inventory_snippet)
                }
            })

            $('#add_editor').on('click', function(evt) {
                if($(this).siblings('.editor').length > 0){
                    $(this).siblings('.editor').last().after(editor_snippet)
                }else{
                    $(this).before(editor_snippet)
                }
            })

            class CharacterDescription{
                character;
                images;
                description;
                location_id;
                traits;
                stats;
                relationships;
                familiar_ids;
                inventories;
                editor_ids;
                constructor(character=null, images=null, description=null, traits=null, stats=null,
                            relationships=null, familiar_ids=null, inventories=null, editor_ids=null, location_id=null){
                    this.character = character;
                    this.images = images;
                    this.description = description;
                    this.traits = traits;
                    this.stats = stats;
                    this.relationships = relationships;
                    this.familiar_ids = familiar_ids;
                    this.editor_ids = editor_ids;
                    this.location_id = location;
                }
            }

            $('#log').on('click', function(evt) {
                console.log(JSON.stringify(create_character_data()))
            })

            $(document).on('click', '.remove_trait,.remove_stat,.remove_familiar,.remove_relationship,.remove_inventory,.remove_editor', function(evt) {
                $(this).parent().remove()
            })

            $('#character_form').on("submit", e => {
                e.preventDefault(); 
                submitForm()
            });
    
            $('#confirm').on('click', () => {
                submitForm()
            })

            function create_character_data(){
                var form = new FormData(document.getElementById('character_form'))

                let trait_names = form.getAll('single_trait')
                let trait_desc = form.getAll('single_trait_desc')

                let traits = []

                for (let i = 0; i < trait_names.length; i++){
                    traits.push({'trait_name':trait_names[i], 'trait_description':trait_desc[i]})
                }

                let stat_names = form.getAll('single_stat')
                let stat_desc = form.getAll('single_stat_desc')

                let stats = []

                for (let i = 0; i < stat_names.length; i++){
                    stats.push({'stat_name':stat_names[i], 'stat_description':stat_desc[i]})
                }

                let relationship_names = form.getAll('single_relationship')
                let character_ids = form.getAll('relationship_character_id')
                let relationship_desc = form.getAll('single_relationship_desc')

                let relationships = []

                for (let i = 0; i < relationship_names.length; i++){
                    relationships.push({'relationship_name':relationship_names[i], 'character_id':parseInt(character_ids[i]), 'relationship_desc':relationship_desc[i]})
                }

                let characterDescription = new CharacterDescription();
                characterDescription.character = {'name':form.get('name'), 'id':parseInt(form.get('character_id'))};
                characterDescription.description = tinymce.get("description").getContent();

                characterDescription.editor_ids = form.getAll('editor_id').map((element) =>{
                    return parseInt(element);
                })

                if(form.get('single_trait')){
                    characterDescription.traits = traits;
                }
                if(form.get('single_stat')){
                    characterDescription.stats = stats;
                }
                if(form.get('single_relationship')){
                    characterDescription.relationships = relationships;
                }

                characterDescription.familiar_ids = form.getAll('familiar_id').map((element) =>{
                    return parseInt(element);
                })

                if(form.get('location')){
                    characterDescription.location_id = parseInt(form.get('location_id'));
                }

                return characterDescription
            }
    
            function submitForm(){
                var description = tinymce.get("description").getContent();
        
                var form = new FormData(document.getElementById('character_form'))
    
                const options = {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body:JSON.stringify(create_character_data())
                };
    
                fetch('/api/character_edit', options).then((response) => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }else{
                        window.location.replace("{{url_for('navi.character_page', character_id = character.editable_id)}}");
                    }
                })
            }
            $(document).on('click', '#location_input, .single_familiar, .single_editor, .relationship_character', function(evt) {
                $("#location_input").autocomplete({
                    source: function( request, response ) {
                      $.ajax({
                        url: '/api/search',
                        method:'POST',
                        dataType: 'json',
                        processData: false,
                        contentType: 'application/json',
                        data:JSON.stringify({
                          search_type: "location",
                          query: request.term
                        }),
                        success: function( data ) {
                          response($.map( data, function(result){
                            return {
                              label:result.label,
                              value:result.value,
                            }
                          }));
                        }
                      });
                    },
                    focus: function(event, ui) {
                      event.preventDefault();
                    },
                    select: function(event, ui) {
                      event.preventDefault();
                      $('#location_input').val(ui.item.label);
                      $('#location_id').val(ui.item.value);
                    },
                    delay: 200
                });
    
                $(".single_familiar").autocomplete({
                    source: function( request, response ) {
                      $.ajax({
                        url: '/api/search',
                        method:'POST',
                        dataType: 'json',
                        processData: false,
                        contentType: 'application/json',
                        data:JSON.stringify({
                          search_type: "familiar",
                          query: request.term
                        }),
                        success: function( data ) {
                          response($.map( data, function(result){
                            return {
                              label:result.label,
                              value:result.value,
                            }
                          }));
                        }
                      });
                    },
                    focus: function(event, ui) {
                      event.preventDefault();
                    },
                    select: function(event, ui) {
                      event.preventDefault();
                      $(this).val(ui.item.label);
                      $(this).siblings().first().val(ui.item.value);
                    },
                    delay: 200
                });

                $(".single_editor").autocomplete({
                    source: function( request, response ) {
                      $.ajax({
                        url: '/api/search',
                        method:'POST',
                        dataType: 'json',
                        processData: false,
                        contentType: 'application/json',
                        data:JSON.stringify({
                          search_type: "user",
                          query: request.term
                        }),
                        success: function( data ) {
                          response($.map( data, function(result){
                            return {
                              label:result.label,
                              value:result.value,
                            }
                          }));
                        }
                      });
                    },
                    focus: function(event, ui) {
                      event.preventDefault();
                    },
                    select: function(event, ui) {
                      event.preventDefault();
                      $(this).val(ui.item.label);
                      $(this).siblings().first().val(ui.item.value);
                    },
                    delay: 200
                });

                $(".relationship_character").autocomplete({
                    source: function( request, response ) {
                      $.ajax({
                        url: '/api/search',
                        method:'POST',
                        dataType: 'json',
                        processData: false,
                        contentType: 'application/json',
                        data:JSON.stringify({
                          search_type: "character",
                          query: request.term
                        }),
                        success: function( data ) {
                          response($.map( data, function(result){
                            return {
                              label:result.label,
                              value:result.value,
                            }
                          }));
                        }
                      });
                    },
                    focus: function(event, ui) {
                      event.preventDefault();
                    },
                    select: function(event, ui) {
                      event.preventDefault();
                      $(this).val(ui.item.label);
                      $(this).siblings('.relationship_character_id').first().val(ui.item.value);
                    },
                    delay: 200
                });
            })
        })
    </script>
{% endblock %}